on:
  push:
    branches:
      - main

defaults:
    run:
        working-directory: ./infra/tf-app  
jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply -auto-approve

    - name: Set Resource Group Name Secret
      run: echo "${{ steps.terraform_outputs.outputs.resource_group_name }}" >> $GITHUB_ENV

    - name: Set Storage Account Name Secret
      run: echo "${{ steps.terraform_outputs.outputs.storage_account_name }}" >> $GITHUB_ENV

    - name: Set Container Name Secret
      run: echo "${{ steps.terraform_outputs.outputs.container_name }}" >> $GITHUB_ENV

    - name: Set Primary Access Key Secret
      run: echo "${{ steps.terraform_outputs.outputs.primary_access_key }}" >> $GITHUB_ENV

    - name: Set ACR Login Server Secret
      run: echo "${{ steps.terraform_outputs.outputs.acr_login_server }}" >> $GITHUB_ENV

    - name: Set ACR Username Secret
      run: echo "${{ steps.terraform_outputs.outputs.acr_username }}" >> $GITHUB_ENV

    - name: Set ACR Password Secret
      run: echo "${{ steps.terraform_outputs.outputs.acr_password }}" >> $GITHUB_ENV

    - name: Upload Secrets
      uses: actions/upload-artifact@v2
      with:
        name: terraform-outputs
        path: terraform-outputs.txt